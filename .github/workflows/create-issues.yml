name: Convert Issues to GitHub Issues

on:
  workflow_dispatch:
    inputs:
      create_all:
        description: 'Create all issues at once'
        required: false
        default: false
        type: boolean
      issue_numbers:
        description: 'Specific issue numbers to create (comma-separated, e.g., "01,02,03")'
        required: false
        default: ''
        type: string

jobs:
  create-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Create GitHub Issues
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Issue metadata mapping
            const issueMetadata = {
              '01': {
                title: 'ğŸ—ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åŸºæœ¬ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—',
                labels: ['enhancement', 'good first issue', 'åˆç´š', 'setup'],
                assignees: [],
                milestone: null
              },
              '02': {
                title: 'ğŸ“¥ Wikipediaãƒ‡ãƒ¼ã‚¿å–å¾—æ©Ÿèƒ½ã®å®Ÿè£…',
                labels: ['feature', 'åˆç´š', 'data-processing'],
                assignees: [],
                milestone: null
              },
              '03': {
                title: 'âœ‚ï¸ ãƒ†ã‚­ã‚¹ãƒˆåˆ†å‰²ï¼ˆãƒãƒ£ãƒ³ã‚­ãƒ³ã‚°ï¼‰æ©Ÿèƒ½ã®å®Ÿè£…', 
                labels: ['feature', 'ä¸­ç´š', 'nlp', 'chunking'],
                assignees: [],
                milestone: null
              },
              '04': {
                title: 'ğŸ”¤ åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«ï¼ˆE5ï¼‰ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨å®Ÿè£…',
                labels: ['feature', 'ä¸­ç´š', 'embedding', 'e5'],
                assignees: [],
                milestone: null
              },
              '05': {
                title: 'ğŸ” FAISSã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ§‹ç¯‰ã¨ä¿å­˜',
                labels: ['feature', 'ä¸­ç´š', 'vector-search', 'faiss'],
                assignees: [],
                milestone: null
              },
              '06': {
                title: 'âš™ï¸ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ§‹ç¯‰ç”¨çµ±åˆã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆbuild_wiki_index.pyï¼‰ã®å®Ÿè£…',
                labels: ['feature', 'ä¸­ç´š', 'pipeline', 'cli'],
                assignees: [],
                milestone: null
              },
              '07': {
                title: 'ğŸ”„ å†ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ã®å®Ÿè£…ï¼ˆBGE Rerankerï¼‰',
                labels: ['feature', 'ä¸­ç´š', 'reranking', 'bge'],
                assignees: [],
                milestone: null
              },
              '08': {
                title: 'ğŸ¤– LLMå¿œç­”ç”Ÿæˆæ©Ÿèƒ½ã®å®Ÿè£…ï¼ˆQwen2.5ï¼‰',
                labels: ['feature', 'ä¸Šç´š', 'llm', 'generation', 'qwen'],
                assignees: [],
                milestone: null
              },
              '09': {
                title: 'ğŸ”— æ¤œç´¢ãƒ»ç”Ÿæˆçµ±åˆã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆrag_wiki.pyï¼‰ã®å®Ÿè£…',
                labels: ['feature', 'ä¸­ç´š', 'rag', 'integration'],
                assignees: [],
                milestone: null
              },
              '10': {
                title: 'ğŸ–¥ï¸ Gradio UIã®å®Ÿè£…ï¼ˆapp_wiki.pyï¼‰',
                labels: ['feature', 'ä¸­ç´š', 'ui', 'gradio', 'web'],
                assignees: [],
                milestone: null
              },
              '11': {
                title: 'ğŸ“Š è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ä½œæˆã¨Recall@Kè©•ä¾¡æ©Ÿèƒ½ã®å®Ÿè£…',
                labels: ['feature', 'ä¸­ç´š', 'evaluation', 'testing'],
                assignees: [],
                milestone: null
              },
              '12': {
                title: 'ğŸ§ª çµ±åˆãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒãƒƒã‚°ãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™',
                labels: ['testing', 'ä¸­ç´š', 'documentation', 'integration'],
                assignees: [],
                milestone: null
              }
            };

            // Function to read markdown file and convert to issue body
            function convertMarkdownToIssueBody(content) {
              // Remove the title (first line with #)
              const lines = content.split('\n');
              const withoutTitle = lines.slice(1).join('\n');
              
              // Add issue template header
              const header = '> ğŸ“‹ **ã“ã®Issueã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ**\n' +
                           '> - äºˆæƒ³ä½œæ¥­æ™‚é–“ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™\n' +
                           '> - ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§é€²æ—ã‚’ç®¡ç†ã—ã¦ãã ã•ã„\n' +
                           '> - å›°ã£ãŸæ™‚ã¯ @RentoYabuki06 ã«ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³\n\n' +
                           '---\n\n';
              
              return header + withoutTitle;
            }

            // Get input parameters  
            console.log('Raw inputs:', context.payload.inputs);
            const createAll = context.payload.inputs.create_all === true || context.payload.inputs.create_all === 'true';
            console.log('Create all flag:', createAll);
            
            const issueNumbers = context.payload.inputs.issue_numbers ? 
              context.payload.inputs.issue_numbers.split(',').map(n => n.trim().padStart(2, '0')) : [];
            console.log('Issue numbers:', issueNumbers);

            // Determine which issues to create
            let issuesToCreate = [];
            if (createAll) {
              issuesToCreate = Object.keys(issueMetadata);
              console.log('Creating all issues:', issuesToCreate);
            } else if (issueNumbers.length > 0) {
              issuesToCreate = issueNumbers.filter(num => issueMetadata[num]);
              console.log('Creating selected issues:', issuesToCreate);
            } else {
              console.log('No issues specified to create - inputs were:', {
                create_all: context.payload.inputs.create_all,
                issue_numbers: context.payload.inputs.issue_numbers
              });
              return;
            }

            if (issuesToCreate.length === 0) {
              console.log('âš ï¸ No issues to create. Exiting.');
              return;
            }

            console.log(`ğŸ“‹ Creating ${issuesToCreate.length} issues: ${issuesToCreate.join(', ')}`);

            // Check if issues directory exists
            console.log('Current working directory:', process.cwd());
            console.log('Directory contents:', fs.readdirSync('.'));
            
            if (!fs.existsSync('issues')) {
              console.error('âŒ Issues directory not found!');
              return;
            }
            
            const issuesDir = 'issues';
            const allFiles = fs.readdirSync(issuesDir);
            console.log('Files in issues directory:', allFiles);

            // Create issues
            for (const issueNum of issuesToCreate) {
              try {
                console.log(`\nğŸ”„ Processing issue ${issueNum}...`);
                
                const matchingFile = allFiles.find(file => file.startsWith(`${issueNum}_`));
                console.log(`Looking for files starting with "${issueNum}_"...`);
                console.log(`Found matching file: ${matchingFile}`);
                
                if (!matchingFile) {
                  console.log(`âŒ File not found for issue ${issueNum}`);
                  console.log(`Available files: ${allFiles.join(', ')}`);
                  continue;
                }

                const fullPath = path.join(issuesDir, matchingFile);
                console.log(`Reading file: ${fullPath}`);
                
                const content = fs.readFileSync(fullPath, 'utf8');
                console.log(`File content length: ${content.length} characters`);
                
                const metadata = issueMetadata[issueNum];
                console.log(`Using metadata:`, metadata);
                
                const issueBody = convertMarkdownToIssueBody(content);
                console.log(`Generated issue body length: ${issueBody.length} characters`);
                
                console.log(`Creating issue with title: "${metadata.title}"`);
                
                const issue = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: metadata.title,
                  body: issueBody,
                  labels: metadata.labels,
                  assignees: metadata.assignees,
                  milestone: metadata.milestone
                });

                console.log(`âœ… Successfully created issue #${issue.data.number}: ${metadata.title}`);
                console.log(`Issue URL: ${issue.data.html_url}`);
                
                // Add a small delay to avoid rate limiting
                await new Promise(resolve => setTimeout(resolve, 1000));
                
              } catch (error) {
                console.error(`âŒ Failed to create issue ${issueNum}:`);
                console.error(`Error message: ${error.message}`);
                console.error(`Error stack: ${error.stack}`);
                if (error.response) {
                  console.error(`Response status: ${error.response.status}`);
                  console.error(`Response data:`, error.response.data);
                }
              }
            }
            
            console.log(`\nğŸ‰ Issue creation process completed!`);
            console.log(`ğŸ“Š Summary:`);
            console.log(`- Attempted to create: ${issuesToCreate.length} issues`);
            console.log(`- Issues requested: ${issuesToCreate.join(', ')}`);
            console.log(`\nğŸ’¡ Check the Issues tab to see created issues.`);
            console.log(`ğŸ” If no issues were created, check the error messages above.`);

      - name: Create Project Board (if not exists)
        uses: actions/github-script@v7
        with:
          script: |
            try {
              // Check if project already exists
              const projects = await github.rest.projects.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              
              const existingProject = projects.data.find(p => p.name === 'Wikipedia RAG Development');
              
              if (!existingProject) {
                const project = await github.rest.projects.createForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: 'Wikipedia RAG Development',
                  body: 'ğŸ“‹ Wikipedia RAG ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ\n\n' +
                        '## ğŸ¯ ç›®æ¨™\n' +
                        'æ—¥æœ¬èªWikipediaãƒ™ãƒ¼ã‚¹ã®RAGã‚·ã‚¹ãƒ†ãƒ ã‚’æ®µéšçš„ã«å®Ÿè£…\n\n' +
                        '## ğŸ“Š é€²æ—ç®¡ç†\n' +
                        '- **ToDo**: æœªç€æ‰‹ã®ã‚¿ã‚¹ã‚¯\n' +
                        '- **In Progress**: ä½œæ¥­ä¸­ã®ã‚¿ã‚¹ã‚¯\n' +
                        '- **Review**: ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡\n' +
                        '- **Done**: å®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯\n\n' +
                        'å„Issueã¯15-30åˆ†ã§å®Œäº†ã§ãã‚‹ã‚ˆã†è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚',
                });
                
                console.log(`âœ… Created project board: ${project.data.name}`);
                
                // Create columns
                const columns = ['ToDo', 'In Progress', 'Review', 'Done'];
                for (const column of columns) {
                  await github.rest.projects.createColumn({
                    project_id: project.data.id,
                    name: column
                  });
                  console.log(`âœ… Created column: ${column}`);
                }
              } else {
                console.log('ğŸ“‹ Project board already exists');
              }
            } catch (error) {
              console.error('âŒ Failed to create project board:', error.message);
            }